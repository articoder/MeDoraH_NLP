<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report_title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500&family=PT+Sans+Narrow:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js" onerror="console.error('Failed to load vis-network from CDN')"></script>
    <script>
        // Check if vis.js loaded and provide fallback
        window.addEventListener('load', function() {
            if (typeof vis === 'undefined') {
                console.error('vis.js failed to load from CDN, trying alternative CDN...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/standalone/umd/vis-network.min.js';
                script.onload = function() {
                    console.log('vis.js loaded from alternative CDN');
                };
                script.onerror = function() {
                    console.error('vis.js failed to load from alternative CDN too');
                };
                document.head.appendChild(script);
            } else {
                console.log('vis.js loaded successfully from primary CDN');
            }
        });
    </script>
    <!-- External CSS Files -->
    <link rel="stylesheet" href="static/css/design-tokens.css">
    <link rel="stylesheet" href="static/css/components.css">
    <link rel="stylesheet" href="static/css/network-modal.css">


</head>
<body>
    <header class="app-bar">
        <div class="app-bar-content">
            <div class="app-bar-title-container">
                <h1 class="app-bar-title">{{ report_title }}</h1>
                <span class="layer-indicator" id="layer-indicator">| Claim Layer</span>
            </div>
            
            <!-- Main Navigation Bar -->
            <nav class="main-nav" id="main-nav">
                <!-- View Layers with Dropdown -->
                <div class="nav-item has-dropdown" id="nav-view-layers">
                    <span>View Layers</span>
                    <div class="nav-dropdown">
                        <div class="nav-dropdown-item" data-layer="discourse">Discourse Layer</div>
                        <div class="nav-dropdown-item" data-layer="narrative">Narrative Layer</div>
                        <div class="nav-dropdown-item" data-layer="claim">Claim Layer</div>
                        <div class="nav-dropdown-item" data-layer="historical">Historical Reference Layer</div>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div class="nav-item" id="nav-statistics">
                    <span>Statistics</span>
                </div>
                
                <!-- Models & API -->
                <div class="nav-item" id="nav-models-api">
                    <span>Models &amp; API</span>
                </div>
                
                <!-- Edit Ontology -->
                <div class="nav-item" id="nav-edit-ontology">
                    <span>Edit Ontology</span>
                </div>
                
                <!-- Search Icon with Expandable Search -->
                <div class="nav-search-container" id="nav-search-container">
                    <button class="nav-search-btn" id="nav-search-btn" title="Search">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                    </button>
                    <div class="nav-search-wrapper" id="nav-search-wrapper">
                        <input type="search" id="entity-search-input" placeholder="Search entities, types, relations..." class="nav-search-input">
                        <button class="nav-search-close" id="nav-search-close" title="Close search">
                            <svg viewBox="0 0 24 24">

                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </nav>
        </div>
        <div class="app-bar-content app-bar-filters">
            <div id="filter-status" class="filter-status-inline">
                <div>
                    <div id="filter-status-content">
                        <div id="search-filter-display" style="display: none;">
                            <h4>Searching for:</h4>
                            <span id="search-filter-text"></span>
                        </div>
                        <div id="type-filter-display" style="display: none;">
                            <h4>Filtering by Type(s):</h4>
                            <div class="badge-container" id="type-filter-tags"></div>
                        </div>
                        <div id="relation-filter-display" style="display: none;">
                            <h4>Filtering by Relation:</h4>
                            <div id="relation-filter-tags"></div>
                        </div>
                        <div id="pattern-filter-display" style="display: none;">
                            <h4>Filtering by Pattern:</h4>
                            <span id="pattern-filter-text"></span>
                        </div>
                    </div>
                    <button id="clear-all-filters-btn">Clear All</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Fixed positioned buttons container -->
    <div class="fixed-buttons-container">
        <button id="visualise-btn" title="Visualize Network Graph">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <circle cx="12" cy="5" r="3"/>
                <circle cx="12" cy="19" r="3"/>
                <circle cx="5" cy="12" r="3"/>
                <circle cx="19" cy="12" r="3"/>
                <line x1="12" y1="9" x2="12" y2="15"/>
                <line x1="9" y1="12" x2="15" y2="12"/>
            </svg>
            Visualise
        </button>
        <button id="back-to-top-btn" title="Back to Top">Back to Top</button>
    </div>

    <div class="container">
        <main class="two-column-layout">
            <div class="main-content-column">
                <div class="global-summary-card" id="global-summary-card">
                    <div class="stat-item">
                        <div class="value" id="stat-total-extractions" data-original="{{ global_stats.total_extractions }}">{{ global_stats.total_extractions }}</div>
                        <div class="label">Total Extractions</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="stat-speaker-turns" data-original="{{ global_stats.total_speaker_turns }}">{{ global_stats.total_speaker_turns }}</div>
                        <div class="label">Speaker Turns</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="stat-unique-entities" data-original="{{ global_stats.unique_entity_names }}">{{ global_stats.unique_entity_names }}</div>
                        <div class="label">Unique Entities</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="stat-unique-entity-types" data-original="{{ global_stats.unique_entity_types }}">{{ global_stats.unique_entity_types }}</div>
                        <div class="label">Unique Entity Types</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="stat-unique-relations" data-original="{{ global_stats.unique_relations }}">{{ global_stats.unique_relations }}</div>
                        <div class="label">Unique Relations</div>
                    </div>
                </div>
                {% for turn in speaker_turns %}
                <div class="speaker-turn"
                     data-speaker-name="{{ turn.speaker_name }}"
                     data-utterance-order="{{ turn.utterance_order }}">
                    <div class="turn-header">
                        <span class="turn-speaker-name">{{ turn.speaker_name }}</span>
                        <span class="turn-meta">{{ turn.role }} | Utterance #{{ turn.utterance_order }} | {{ turn.extraction_count }} Extractions</span>
                    </div>

                    {# Group extractions by evidence (same sentence) #}
                    {% for group in turn.extractions | groupby('evidence_text') %}
                    {% set group_list = group.list %}
                    {% set first = group_list[0] %}

                    {# Build aggregated data attributes for filtering across all triples in the card #}
                    {% set subj_types_join = group_list | map(attribute='subject_entity') | map(attribute='entity_type') | join('|') %}
                    {% set obj_types_join = group_list | map(attribute='object_entity') | map(attribute='entity_type') | join('|') %}
                    {% set rel_forms_join = group_list | map(attribute='relation') | map(attribute='semantic_form') | join('|') %}
                    {% set rel_surfaces_join = group_list | map(attribute='relation') | map(attribute='surface_form') | join('|') %}
                    {% set subj_names_join = group_list | map(attribute='subject_entity') | map(attribute='name') | map('lower') | join('|') %}
                    {% set obj_names_join = group_list | map(attribute='object_entity') | map(attribute='name') | map('lower') | join('|') %}
                    {% set ns = namespace(patterns_join='') %}
                    {% for ex in group_list %}
                        {% set ns.patterns_join = ns.patterns_join + (ns.patterns_join and '|' or '') + (ex.subject_entity.entity_type ~ '::' ~ ex.relation.semantic_form ~ '::' ~ ex.object_entity.entity_type) %}
                    {% endfor %}
                    {% set evidence_sources_join = '' %}
                    {% if first.evidence_sources %}
                        {% set evidence_sources_join = first.evidence_sources | join('|') %}
                    {% endif %}

                    <div class="extraction-card"
                         data-subject-types="{{ subj_types_join }}"
                         data-subject-names="{{ subj_names_join }}"
                         data-relation-forms="{{ rel_forms_join }}"
                         data-relation-surfaces="{{ rel_surfaces_join }}"
                         data-object-types="{{ obj_types_join }}"
                         data-object-names="{{ obj_names_join }}"
                         data-patterns="{{ ns.patterns_join }}"
                         data-evidence-text="{{ group.grouper }}"
                         data-evidence-sources="{{ evidence_sources_join }}">

                        {# Render each triple within the group, separated by a divider #}
                        {% for extraction in group_list %}
                        <div class="sro-triple">
                            <div class="entity-box subject">
                                <span class="entity-name">{{ extraction.subject_entity.name }}</span>
                                {% set subj_utt_count = entity_utterance_counts_map.get(extraction.subject_entity.entity_type, 0) %}
                                <span class="entity-type-badge {% if subj_utt_count > 3 %}badge-freq-high{% elif subj_utt_count >= 2 %}badge-freq-medium{% else %}badge-freq-low{% endif %}">
                                    {{ extraction.subject_entity.entity_type }}
                                </span>
                            </div>
                            <div class="relation-link"><span class="relation-semantic-form">{{ extraction.relation.semantic_form }}</span><span class="relation-arrow">&rarr;</span></div>
                            <div class="entity-box object">
                                <span class="entity-name">{{ extraction.object_entity.name }}</span>
                                {% set obj_utt_count = entity_utterance_counts_map.get(extraction.object_entity.entity_type, 0) %}
                                <span class="entity-type-badge {% if obj_utt_count > 3 %}badge-freq-high{% elif obj_utt_count >= 2 %}badge-freq-medium{% else %}badge-freq-low{% endif %}">
                                    {{ extraction.object_entity.entity_type }}
                                </span>
                            </div>
                        </div>
                        <div class="relation-details">Surface Form: <code>"{{ extraction.relation.surface_form }}"</code></div>
                        {% if not loop.last %}<hr class="triple-divider">{% endif %}
                        {% endfor %}

                        <div class="evidence-section">
                            <h3>Evidence Source</h3>
                            <blockquote class="evidence-text">{{ group.grouper }}</blockquote>
                            <div class="evidence-sources">{% for source_id in first.evidence_sources %}<span class="evidence-id-tag">{{ source_id }}</span>{% endfor %}</div>
                        </div>
                    </div>
                    {% else %}
                    <div class="extraction-card" style="text-align: center; color: var(--fg-secondary);"><p>No extractions found for this utterance.</p></div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="extraction-card" style="text-align: center; color: var(--fg-secondary);"><p>No speaker turns found in the provided data.</p></div>
                {% endfor %}
            </div>

            <aside class="sidebar-column" id="sidebar">
                <div class="sidebar-panel" id="export-panel">
                    <div class="section-header-with-actions">
                        <h2>Export</h2>
                    </div>
                    <div class="export-options-list">
                        <label class="export-option">
                            <input type="checkbox" id="export-option-entities">
                            <span>Entity Types CSV</span>
                        </label>
                        <label class="export-option">
                            <input type="checkbox" id="export-option-patterns">
                            <span>Pattern Analytics (Export All)</span>
                        </label>
                        <label class="export-option">
                            <input type="checkbox" id="export-option-triples">
                            <span>Filtered Triples (JSON)</span>
                        </label>
                    </div>
                    <button id="export-selected-btn" class="export-csv-btn" title="Export selected data" style="margin-top: var(--sp-4);">
                        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Export Selected
                    </button>
                </div>
                <div class="sidebar-panel" id="filter-and-search-panel">
                    <h2>Entity Types <span style="font-weight: 400; font-size: var(--fs-sm); color: var(--fg-secondary);">(Click to Filter)</span></h2>
                    
                    {% if all_entity_types %}
                    <div>
                        <div class="legend-container">
                            <div class="legend-item"><div class="legend-color-box" style="background-color: var(--accent);"></div><span>&gt; 3 Utterances</span></div>
                            <div class="legend-item"><div class="legend-color-box" style="background-color: var(--accent-secondary);"></div><span>2-3 Utterances</span></div>
                            <div class="legend-item"><div class="legend-color-box" style="background-color: var(--accent-tertiary);"></div><span>1 Utterance</span></div>
                        </div>
                        <div id="entity-type-filter-container">
                            {% if entity_types_high_freq %}
                            <div class="entity-type-section">
                                <h4>More than 3 Utterances ({{ entity_types_high_freq|length }})</h4>
                                <div class="badge-container">
                                    {% for type_info in entity_types_high_freq %}
                                    <span class="entity-type-badge filterable-badge badge-freq-high"
                                          data-entity-type="{{ type_info.name }}"
                                          data-total-count="{{ type_info.count }}"
                                          data-utterance-count="{{ type_info.utterance_count }}">
                                          {{ type_info.name }} [{{ type_info.count }}]
                                    </span>
                                    {% endfor %}
                                </div>
                                <button class="toggle-button entity-group-toggle" style="display: none;">Show More</button>
                            </div>
                            {% endif %}

                            {% if entity_types_medium_freq %}
                            <div class="entity-type-section">
                                <h4>2-3 Utterances ({{ entity_types_medium_freq|length }})</h4>
                                <div class="badge-container">
                                    {% for type_info in entity_types_medium_freq %}
                                    <span class="entity-type-badge filterable-badge badge-freq-medium"
                                          data-entity-type="{{ type_info.name }}"
                                          data-total-count="{{ type_info.count }}"
                                          data-utterance-count="{{ type_info.utterance_count }}">
                                          {{ type_info.name }} [{{ type_info.count }}]
                                    </span>
                                    {% endfor %}
                                </div>
                                <button class="toggle-button entity-group-toggle" style="display: none;">Show More</button>
                            </div>
                            {% endif %}

                            {% if entity_types_low_freq %}
                            <div class="entity-type-section">
                                <h4>1 Utterance ({{ entity_types_low_freq|length }})</h4>
                                <div class="badge-container">
                                    {% for type_info in entity_types_low_freq %}
                                    <span class="entity-type-badge filterable-badge badge-freq-low"
                                          data-entity-type="{{ type_info.name }}"
                                          data-total-count="{{ type_info.count }}"
                                          data-utterance-count="{{ type_info.utterance_count }}">
                                          {{ type_info.name }} [{{ type_info.count }}]
                                    </span>
                                    {% endfor %}
                                </div>
                                <button class="toggle-button entity-group-toggle" style="display: none;">Show More</button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div id="analytics-panel">
                    <div class="section-header-with-actions">
                        <h2>Pattern Analytics</h2>
                    </div>
                    <div class="summary-section collapsible collapsed">
                        <div class="collapsible-header">
                            <h3>Entity Type Patterns</h3>
                            <span class="chevron"></span>
                        </div>
                        <div class="collapsible-content">
                            <h4>Multi-Typed Entities ({{ multi_typed_entities|length }} found)</h4>
                            <ul class="stats-list">
                                {% for name, types in multi_typed_entities.items() %}
                                <li>
                                    <span>{{ name }}</span> 
                                    <div class="badge-container">
                                        {% for type in types %}
                                            {% set utt_count = entity_utterance_counts_map.get(type, 0) %}
                                            <span class="entity-type-badge {% if utt_count > 3 %}badge-freq-high{% elif utt_count >= 2 %}badge-freq-medium{% else %}badge-freq-low{% endif %}">{{ type }}</span>
                                        {% endfor %}
                                    </div>
                                </li>
                                {% else %}<li class="empty-state" style="justify-content: flex-start;">None found.</li>{% endfor %}
                            </ul>
                            <h4>Subject-Only Entity Types ({{ subject_only_types|length }} types)</h4>
                            <div class="badge-container">
                                {% for type in subject_only_types %}{% set utt_count = entity_utterance_counts_map.get(type, 0) %}{% set total_count = entity_total_counts_map.get(type, 0) %}<span class="entity-type-badge filterable-badge {% if utt_count > 3 %}badge-freq-high{% elif utt_count >= 2 %}badge-freq-medium{% else %}badge-freq-low{% endif %}" data-entity-type="{{ type }}" data-total-count="{{ total_count }}" data-utterance-count="{{ utt_count }}">{{ type }} [{{ total_count }}]</span>{% else %}<span class="empty-state">None found.</span>{% endfor %}
                            </div>
                            <h4>Object-Only Entity Types ({{ object_only_types|length }} types)</h4>
                            <div class="badge-container">
                                {% for type in object_only_types %}{% set utt_count = entity_utterance_counts_map.get(type, 0) %}{% set total_count = entity_total_counts_map.get(type, 0) %}<span class="entity-type-badge filterable-badge {% if utt_count > 3 %}badge-freq-high{% elif utt_count >= 2 %}badge-freq-medium{% else %}badge-freq-low{% endif %}" data-entity-type="{{ type }}" data-total-count="{{ total_count }}" data-utterance-count="{{ utt_count }}">{{ type }} [{{ total_count }}]</span>{% else %}<span class="empty-state">None found.</span>{% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-section collapsible collapsed">
                        <div class="collapsible-header">
                            <h3>Relation Cardinality Patterns</h3>
                            <span class="chevron"></span>
                        </div>
                        <div class="collapsible-content">
                            <h4>One-to-One (by Type)</h4>
                            <ul class="stats-list">
                                {% for rel, patterns in one_to_one_relations_sorted %}
                                <li>
                                    <code class="pattern-rel filterable-relation" data-relation-form="{{ rel }}">{{ rel }}</code>
                                    <span>{{ relation_frequency_map.get(rel, 0) }} occurrence(s) â€¢ {{ patterns|length }} pattern(s){% if patterns %}, e.g., ({{ patterns[0][0] }}){% endif %}</span>
                                </li>
                                {% else %}
                                <li class="empty-state">No self-relations (e.g., PERSON &rarr; PERSON) found.</li>
                                {% endfor %}
                            </ul>
                            <h4>One-to-Many Relations</h4>
                            <ul class="stats-list">
                                {% for rel in one_to_many_relations_sorted %}
                                <li>
                                    <code class="pattern-rel filterable-relation" data-relation-form="{{ rel }}">{{ rel }}</code>
                                    <span>{{ relation_frequency_map.get(rel, 0) }} occurrence(s) (1:N Cardinality)</span>
                                </li>
                                {% else %}
                                <li class="empty-state" style="justify-content: flex-start;">None found.</li>
                                {% endfor %}
                            </ul>
                            <h4>Many-to-One Relations</h4>
                            <ul class="stats-list">
                                {% for rel in many_to_one_relations_sorted %}
                                <li>
                                    <code class="pattern-rel filterable-relation" data-relation-form="{{ rel }}">{{ rel }}</code>
                                    <span>{{ relation_frequency_map.get(rel, 0) }} occurrence(s) (N:1 Cardinality)</span>
                                </li>
                                {% else %}
                                <li class="empty-state" style="justify-content: flex-start;">None found.</li>
                                {% endfor %}
                            </ul>
                            <h4>Top {{ top_diverse_relations|length }} Relations by Domain/Range Diversity</h4>
                            <ul class="stats-list">
                                {% for item in top_diverse_relations %}<li><code class="pattern-rel filterable-relation" data-relation-form="{{ item.rel }}">{{ item.rel }}</code> <span>{{ item.domain_size }} Subj Type(s) / {{ item.range_size }} Obj Type(s)</span></li>{% else %}<li class="empty-state">Not enough data to analyze diversity.</li>{% endfor %}
                            </ul>
                        </div>
                    </div>

                    {% if most_frequent_patterns %}
                    <div class="summary-section patterns-column collapsible collapsed">
                        <div class="collapsible-header section-header-with-actions">
                            <h3>Frequent Structural Patterns</h3>
                            <span class="chevron"></span>
                        </div>
                        <div class="collapsible-content">
                            <div class="patterns-controls" style="display: flex; gap: var(--sp-4); align-items: center; margin-bottom: var(--sp-4); flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: var(--sp-2); font-size: var(--fs-sm); color: var(--fg-secondary);">
                                    Show:
                                    <select id="patterns-display-count" style="padding: var(--sp-1) var(--sp-2); border-radius: var(--radius-interactive); border: 1px solid var(--border-primary); font-family: var(--font-primary); font-size: var(--fs-sm); background: var(--bg-primary);">
                                        <option value="10">10</option>
                                        <option value="25" selected>25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                        <option value="150">150</option>
                                    </select>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--sp-2); font-size: var(--fs-sm); color: var(--fg-secondary);">
                                    Sort:
                                    <button id="patterns-sort-toggle" class="network-control-btn" style="font-size: var(--fs-sm); padding: var(--sp-1) var(--sp-3);" title="Toggle sort order">
                                        Descending â–¼
                                    </button>
                                </label>
                            </div>
                            <ol id="structural-patterns-list" class="patterns-list-single">
                                {% for pattern, count in most_frequent_patterns %}<li data-filter-subject="{{ pattern[0] }}" data-filter-relation="{{ pattern[1] }}" data-filter-object="{{ pattern[2] }}" data-count="{{ count }}"><span class="rank">{{ loop.index }}.</span><span class="pattern">{{ pattern[0] }} &rarr; <span class="pattern-rel">{{ pattern[1] }}</span> &rarr; {{ pattern[2] }}</span><span class="count">{{ count }}</span></li>{% endfor %}
                            </ol>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </aside>
        </main>
    </div>

    <!-- Network Visualization Modal -->
    <div id="network-modal" class="network-modal">
        <div class="network-modal-content">
            <div class="network-modal-header">
                <div class="network-modal-title">
                    <span>Network Visualization</span>
                    <div class="network-legend" id="network-legend" style="display: none;">
                        <!-- Legend items will be populated dynamically -->
                    </div>
                </div>
                <div class="network-controls">
                    <input type="search" id="network-search" placeholder="Search nodes..." class="network-search-input" title="Search for nodes by name">
                    <button class="network-control-btn active" id="physics-toggle" title="Toggle Physics (P)">Physics</button>
                    <div class="network-labels-dropdown">
                        <button class="network-control-btn" id="labels-btn" title="Toggle Labels (L)">Labels â–¼</button>
                        <div class="labels-menu" id="labels-menu">
                            <button id="toggle-node-labels" class="active">Node Labels</button>
                            <button id="toggle-edge-labels">Edge Labels</button>
                        </div>
                    </div>
                    <div class="network-hops-dropdown">
                        <button class="network-control-btn" id="hops-btn" title="Set Hop Distance">Hops: 0 â–¼</button>
                        <div class="hops-menu" id="hops-menu">
                            <button id="hops-0" data-hops="0" class="active">0 (Exact)</button>
                            <button id="hops-1" data-hops="1">+1 Hop</button>
                            <button id="hops-2" data-hops="2">+2 Hops</button>
                        </div>
                    </div>
                    <button class="network-control-btn" id="fit-network" title="Fit Network to View (F)">Fit</button>
                    <button class="network-control-btn" id="cluster-toggle" title="Toggle Clustering (C)">Cluster</button>
                    <div class="network-export-dropdown">
                        <button class="network-control-btn" id="export-btn" title="Export Network">Export â–¼</button>
                        <div class="export-menu" id="export-menu">
                            <button id="export-png">PNG Image</button>
                            <button id="export-json">JSON Data</button>
                            <button id="export-csv">CSV Edges</button>
                        </div>
                    </div>
                    <button class="network-modal-close" id="network-modal-close">&times;</button>
                </div>
            </div>
            <div class="network-container">
                <div class="network-loading" id="network-loading">
                    <div class="loading-spinner"></div>
                    <p>Generating network visualization...</p>
                </div>
                <div class="network-info" id="network-info" style="display: none;">
                    <strong>Filtered Network:</strong> <span id="filtered-stats"></span>
                </div>
                <div class="network-tips" id="network-tips">
                    ðŸ’¡ <strong>Tips:</strong> Scroll to zoom â€¢ Drag to pan â€¢ Click nodes for details â€¢ Search above â€¢ Shortcuts: P(hysics) L(abels) F(it) C(luster)
                </div>
                <div id="network-graph" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- External JavaScript Files -->
    <script src="static/js/utils.js"></script>
    <script src="static/js/filter-engine.js"></script>
    <script src="static/js/network-viz.js"></script>
    <script src="static/js/main.js"></script>

    <script>
        // =====================================================
        // JINJA2 DATA INJECTION
        // This section MUST remain inline as it uses Jinja2 template expressions
        // =====================================================
        
        // Embed raw triple data for network visualization
        window.rawTripleData = {{ speaker_turns | tojson }};
        
        // Initialize network visualization components after vis.js loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeNetworkComponents);
        } else {
            initializeNetworkComponents();
        }
    </script>

    <script>
        // =====================================================
        // EXPORT FUNCTIONS (require Jinja2 data)
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            
            // Entity Types CSV Export
            function exportEntityTypesCSV() {
                const entityData = {{ all_entity_types | tojson }};
                const csvHeaders = ['entity_type', 'total_frequency', 'utterance_occurrences'];
                const csvRows = entityData.map(row => [`"${row.name.replace(/"/g, '""')}"`, row.count, row.utterance_count]);
                const csvContent = [csvHeaders.join(','), ...csvRows.map(row => row.join(','))].join('\n');
                downloadCSV(csvContent, 'entity_type_statistics.csv');
            }

            // Pattern Analytics Export
            function exportPatternAnalyticsAll() {
                try {
                    const multiTyped = {{ multi_typed_entities | tojson }};
                    const header1 = 'Multi-Typed Entities,Types';
                    const rows1 = Object.entries(multiTyped).map(([name, types]) => {
                        const safeName = `"${String(name).replace(/"/g, '""')}"`;
                        const joinedTypes = `"${(types || []).join(', ').replace(/"/g, '""')}"`;
                        return `${safeName},${joinedTypes}`;
                    });
                    downloadCSV([header1, ...rows1].join('\n'), 'entity_type_patterns.csv');
                } catch (e) { console.error('Export multi-typed entities failed', e); }

                try {
                    const oneToOne = {{ one_to_one_relations_sorted | tojson }};
                    const oneToMany = {{ one_to_many_relations_sorted | tojson }};
                    const manyToOne = {{ many_to_one_relations_sorted | tojson }};
                    const relFreq = {{ relation_frequency_map | tojson }};
                    const topDiverse = {{ top_diverse_relations | tojson }};
                    const lines = [];
                    lines.push('One-to-One (by Type),Occurence');
                    oneToOne.forEach(([rel, patterns]) => lines.push(`"${String(rel).replace(/"/g, '""')}",${Array.isArray(patterns) ? patterns.length : 0}`));
                    lines.push('', 'One-to-Many Relations,Occurence');
                    oneToMany.forEach(rel => lines.push(`"${String(rel).replace(/"/g, '""')}",${relFreq && rel in relFreq ? relFreq[rel] : 0}`));
                    lines.push('', 'Many-to-One Relations,Occurence');
                    manyToOne.forEach(rel => lines.push(`"${String(rel).replace(/"/g, '""')}",${relFreq && rel in relFreq ? relFreq[rel] : 0}`));
                    lines.push('', `Top ${topDiverse?.length || 0} Relations by Domain/Range Diversity`, 'Relation,Domain Types,Range Types');
                    (topDiverse || []).forEach(item => lines.push(`"${String(item.rel).replace(/"/g, '""')}",${item.domain_size},${item.range_size}`));
                    downloadCSV(lines.join('\n'), 'relation_cardinality_patterns.csv');
                } catch (e) { console.error('Export relation cardinality patterns failed', e); }

                try {
                    const allPatternsData = {{ all_structural_patterns | tojson }};
                    const csvRows = allPatternsData.map(item => [`"${item[0][0]} -> ${item[0][1]} -> ${item[0][2]}"`, item[1]]);
                    downloadCSV(['structural_pattern,frequency', ...csvRows.map(row => row.join(','))].join('\n'), 'structural_pattern_statistics.csv');
                } catch (e) { console.error('Export structural patterns failed', e); }
            }

            function exportFilteredTriplesJSON() {
                const data = window.collectFilteredTriples ? window.collectFilteredTriples() : [];
                if (!data || data.length === 0) { alert('No triples match the current filters.'); return; }
                downloadJSON(data, 'filtered_triples.json');
            }

            // Export button handlers
            const exportSelectedBtn = document.getElementById('export-selected-btn');
            if (exportSelectedBtn) {
                exportSelectedBtn.addEventListener('click', () => {
                    const runEntity = document.getElementById('export-option-entities')?.checked;
                    const runPattern = document.getElementById('export-option-patterns')?.checked;
                    const runTriples = document.getElementById('export-option-triples')?.checked;
                    if (!runEntity && !runPattern && !runTriples) { alert('Please select at least one export option.'); return; }
                    if (runEntity) exportEntityTypesCSV();
                    if (runPattern) exportPatternAnalyticsAll();
                    if (runTriples) exportFilteredTriplesJSON();
                });
            }

            // Standalone export buttons (backwards compatibility)
            document.getElementById('export-entity-csv-btn')?.addEventListener('click', exportEntityTypesCSV);
            document.getElementById('export-patterns-csv-btn')?.addEventListener('click', () => {
                const allPatternsData = {{ all_structural_patterns | tojson }};
                const csvRows = allPatternsData.map(item => [`"${item[0][0]} -> ${item[0][1]} -> ${item[0][2]}"`, item[1]]);
                downloadCSV(['structural_pattern,frequency', ...csvRows.map(row => row.join(','))].join('\n'), 'structural_pattern_statistics.csv');
            });
        });
    </script>

    <!-- Jinja2-dependent export functions (must remain inline due to template expressions) -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Individual export routines
        function exportEntityTypesCSV() {
            const entityData = {{ all_entity_types | tojson }};
            const csvHeaders = ['entity_type', 'total_frequency', 'utterance_occurrences'];
            const csvRows = entityData.map(row => [`"${row.name.replace(/"/g, '""')}"`, row.count, row.utterance_count]);
            const csvContent = [csvHeaders.join(','), ...csvRows.map(row => row.join(','))].join('\\n');
            downloadCSV(csvContent, 'entity_type_statistics.csv');
        }

        function exportPatternAnalyticsAll() {
            // 1) Entity Type Patterns: Multi-Typed Entities -> Types
            try {
                const multiTyped = {{ multi_typed_entities | tojson }};
                const header1 = 'Multi-Typed Entities,Types';
                const rows1 = Object.entries(multiTyped).map(([name, types]) => {
                    const safeName = `"${String(name).replace(/"/g, '""')}"`;
                    const joinedTypes = `"${(types || []).join(', ').replace(/"/g, '""')}"`;
                    return `${safeName},${joinedTypes}`;
                });
                const content1 = [header1, ...rows1].join('\n');
                downloadCSV(content1, 'entity_type_patterns.csv');
            } catch (e) { console.error('Export multi-typed entities failed', e); }

            // 2) Relation Cardinality Patterns
            try {
                const oneToOne = {{ one_to_one_relations_sorted | tojson }}; // [ [rel, patterns], ... ]
                const oneToMany = {{ one_to_many_relations_sorted | tojson }}; // [ rel, ... ]
                const manyToOne = {{ many_to_one_relations_sorted | tojson }}; // [ rel, ... ]
                const relFreq = {{ relation_frequency_map | tojson }}; // { rel: count }
                const topDiverse = {{ top_diverse_relations | tojson }}; // [ {rel, domain_size, range_size}, ... ]

                const lines = [];
                // One-to-One (by Type)
                lines.push('One-to-One (by Type),Occurence');
                oneToOne.forEach(([rel, patterns]) => {
                    const occ = Array.isArray(patterns) ? patterns.length : 0;
                    const safeRel = `"${String(rel).replace(/"/g, '""')}"`;
                    lines.push(`${safeRel},${occ}`);
                });
                lines.push('');

                // One-to-Many
                lines.push('One-to-Many Relations,Occurence');
                oneToMany.forEach(rel => {
                    const cnt = relFreq && rel in relFreq ? relFreq[rel] : 0;
                    const safeRel = `"${String(rel).replace(/"/g, '""')}"`;
                    lines.push(`${safeRel},${cnt}`);
                });
                lines.push('');

                // Many-to-One
                lines.push('Many-to-One Relations,Occurence');
                manyToOne.forEach(rel => {
                    const cnt = relFreq && rel in relFreq ? relFreq[rel] : 0;
                    const safeRel = `"${String(rel).replace(/"/g, '""')}"`;
                    lines.push(`${safeRel},${cnt}`);
                });
                lines.push('');

                // Top N by Domain/Range Diversity
                const topN = Array.isArray(topDiverse) ? topDiverse.length : 0;
                lines.push(`Top ${topN} Relations by Domain/Range Diversity`);
                lines.push('Relation,Domain Types,Range Types');
                (topDiverse || []).forEach(item => {
                    const safeRel = `"${String(item.rel).replace(/"/g, '""')}"`;
                    lines.push(`${safeRel},${item.domain_size},${item.range_size}`);
                });

                downloadCSV(lines.join('\n'), 'relation_cardinality_patterns.csv');
            } catch (e) { console.error('Export relation cardinality patterns failed', e); }

            // 3) Frequent Structural Patterns (all)
            try {
                const allPatternsData = {{ all_structural_patterns | tojson }};
                const csvHeaders = ['structural_pattern', 'frequency'];
                const csvRows = allPatternsData.map(item => {
                    const patternTuple = item[0];
                    const count = item[1];
                    const patternString = `"${patternTuple[0]} -> ${patternTuple[1]} -> ${patternTuple[2]}"`;
                    return [patternString, count];
                });
                const csvContent = [csvHeaders.join(','), ...csvRows.map(row => row.join(','))].join('\n');
                downloadCSV(csvContent, 'structural_pattern_statistics.csv');
            } catch (e) { console.error('Export structural patterns failed', e); }
        }

        // Combined export card: hook up checkboxes + button
        const exportSelectedBtn = document.getElementById('export-selected-btn');
        const exportOptionEntities = document.getElementById('export-option-entities');
        const exportOptionPatterns = document.getElementById('export-option-patterns');
        const exportOptionTriples = document.getElementById('export-option-triples');

        function exportFilteredTriplesJSON() {
            const data = collectFilteredTriples();
            if (!data || data.length === 0) {
                alert('No triples match the current filters.');
                return;
            }
            downloadJSON(data, 'filtered_triples.json');
        }

        if (exportSelectedBtn) {
            exportSelectedBtn.addEventListener('click', () => {
                const runEntityExport = exportOptionEntities && exportOptionEntities.checked;
                const runPatternExport = exportOptionPatterns && exportOptionPatterns.checked;
                const runTriplesExport = exportOptionTriples && exportOptionTriples.checked;

                if (!runEntityExport && !runPatternExport && !runTriplesExport) {
                    alert('Please select at least one export option.');
                    return;
                }

                if (runEntityExport) {
                    exportEntityTypesCSV();
                }
                if (runPatternExport) {
                    exportPatternAnalyticsAll();
                }
                if (runTriplesExport) {
                    exportFilteredTriplesJSON();
                }
            });
        }

        // Backwards compatibility: keep standalone triggers if present
        const exportEntityCSVBtn = document.getElementById('export-entity-csv-btn');
        if (exportEntityCSVBtn) {
            exportEntityCSVBtn.addEventListener('click', exportEntityTypesCSV);
        }

        const exportPatternsCSVBtn = document.getElementById('export-patterns-csv-btn');
        if (exportPatternsCSVBtn) {
            exportPatternsCSVBtn.addEventListener('click', () => {
                const allPatternsData = {{ all_structural_patterns | tojson }};
                const csvHeaders = ['structural_pattern', 'frequency'];
                const csvRows = allPatternsData.map(item => {
                    const patternTuple = item[0];
                    const count = item[1];
                    const patternString = `"${patternTuple[0]} -> ${patternTuple[1]} -> ${patternTuple[2]}"`;
                    return [patternString, count];
                });
                const csvContent = [csvHeaders.join(','), ...csvRows.map(row => row.join(','))].join('\n');
                downloadCSV(csvContent, 'structural_pattern_statistics.csv');
            });
        }
    });
    </script>
</body>
</html>
