{# Sidebar Partial - Export panel, entity type filters, and pattern analytics #}
<aside class="sidebar-column" id="sidebar">
    {# Export Panel #}
    <div class="sidebar-panel" id="export-panel">
        <div class="section-header-with-actions">
            <h2>Export</h2>
        </div>
        <div class="export-options-list">
            <label class="export-option">
                <input type="checkbox" id="export-option-entities">
                <span>Entity Types CSV</span>
            </label>
            <label class="export-option">
                <input type="checkbox" id="export-option-patterns">
                <span>Pattern Analytics (Export All)</span>
            </label>
            <label class="export-option">
                <input type="checkbox" id="export-option-triples">
                <span>Filtered Triples (JSON)</span>
            </label>
        </div>
        <button id="export-selected-btn" class="export-csv-btn" title="Export selected data" style="margin-top: var(--sp-4);">
            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Export Selected
        </button>
    </div>

    {# Entity Types Filter Panel #}
    <div class="sidebar-panel" id="filter-and-search-panel">
        <h2>Entity Types <span style="font-weight: 400; font-size: var(--fs-sm); color: var(--fg-secondary);">(Click to Filter)</span></h2>
        
        {% if all_entity_types %}
        <div>
            <div class="legend-container">
                <div class="legend-item"><div class="legend-color-box" style="background-color: var(--accent);"></div><span>&gt; 3 Utterances</span></div>
                <div class="legend-item"><div class="legend-color-box" style="background-color: var(--accent-secondary);"></div><span>2-3 Utterances</span></div>
                <div class="legend-item"><div class="legend-color-box" style="background-color: var(--accent-tertiary);"></div><span>1 Utterance</span></div>
            </div>
            <div id="entity-type-filter-container">
                {% if entity_types_high_freq %}
                <div class="entity-type-section">
                    <h4>More than 3 Utterances ({{ entity_types_high_freq|length }})</h4>
                    <div class="badge-container">
                        {% for type_info in entity_types_high_freq %}
                        <span class="entity-type-badge filterable-badge badge-freq-high"
                              data-entity-type="{{ type_info.name }}"
                              data-total-count="{{ type_info.count }}"
                              data-utterance-count="{{ type_info.utterance_count }}">
                              {{ type_info.name }} [{{ type_info.count }}]
                        </span>
                        {% endfor %}
                    </div>
                    <button class="toggle-button entity-group-toggle" style="display: none;">Show More</button>
                </div>
                {% endif %}

                {% if entity_types_medium_freq %}
                <div class="entity-type-section">
                    <h4>2-3 Utterances ({{ entity_types_medium_freq|length }})</h4>
                    <div class="badge-container">
                        {% for type_info in entity_types_medium_freq %}
                        <span class="entity-type-badge filterable-badge badge-freq-medium"
                              data-entity-type="{{ type_info.name }}"
                              data-total-count="{{ type_info.count }}"
                              data-utterance-count="{{ type_info.utterance_count }}">
                              {{ type_info.name }} [{{ type_info.count }}]
                        </span>
                        {% endfor %}
                    </div>
                    <button class="toggle-button entity-group-toggle" style="display: none;">Show More</button>
                </div>
                {% endif %}

                {% if entity_types_low_freq %}
                <div class="entity-type-section">
                    <h4>1 Utterance ({{ entity_types_low_freq|length }})</h4>
                    <div class="badge-container">
                        {% for type_info in entity_types_low_freq %}
                        <span class="entity-type-badge filterable-badge badge-freq-low"
                              data-entity-type="{{ type_info.name }}"
                              data-total-count="{{ type_info.count }}"
                              data-utterance-count="{{ type_info.utterance_count }}">
                              {{ type_info.name }} [{{ type_info.count }}]
                        </span>
                        {% endfor %}
                    </div>
                    <button class="toggle-button entity-group-toggle" style="display: none;">Show More</button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    {# Pattern Analytics Panel #}
    <div id="analytics-panel">
        <div class="section-header-with-actions">
            <h2>Pattern Analytics</h2>
        </div>
        
        {# Entity Type Patterns #}
        <div class="summary-section collapsible collapsed">
            <div class="collapsible-header">
                <h3>Entity Type Patterns</h3>
                <span class="chevron"></span>
            </div>
            <div class="collapsible-content">
                <h4>Multi-Typed Entities ({{ multi_typed_entities|length }} found)</h4>
                <ul class="stats-list">
                    {% for name, types in multi_typed_entities.items() %}
                    <li>
                        <span>{{ name }}</span> 
                        <div class="badge-container">
                            {% for type in types %}
                                {% set utt_count = entity_utterance_counts_map.get(type, 0) %}
                                <span class="entity-type-badge {% if utt_count > 3 %}badge-freq-high{% elif utt_count >= 2 %}badge-freq-medium{% else %}badge-freq-low{% endif %}">{{ type }}</span>
                            {% endfor %}
                        </div>
                    </li>
                    {% else %}<li class="empty-state" style="justify-content: flex-start;">None found.</li>{% endfor %}
                </ul>
                <h4>Subject-Only Entity Types ({{ subject_only_types|length }} types)</h4>
                <div class="badge-container">
                    {% for type in subject_only_types %}{% set utt_count = entity_utterance_counts_map.get(type, 0) %}{% set total_count = entity_total_counts_map.get(type, 0) %}<span class="entity-type-badge filterable-badge {% if utt_count > 3 %}badge-freq-high{% elif utt_count >= 2 %}badge-freq-medium{% else %}badge-freq-low{% endif %}" data-entity-type="{{ type }}" data-total-count="{{ total_count }}" data-utterance-count="{{ utt_count }}">{{ type }} [{{ total_count }}]</span>{% else %}<span class="empty-state">None found.</span>{% endfor %}
                </div>
                <h4>Object-Only Entity Types ({{ object_only_types|length }} types)</h4>
                <div class="badge-container">
                    {% for type in object_only_types %}{% set utt_count = entity_utterance_counts_map.get(type, 0) %}{% set total_count = entity_total_counts_map.get(type, 0) %}<span class="entity-type-badge filterable-badge {% if utt_count > 3 %}badge-freq-high{% elif utt_count >= 2 %}badge-freq-medium{% else %}badge-freq-low{% endif %}" data-entity-type="{{ type }}" data-total-count="{{ total_count }}" data-utterance-count="{{ utt_count }}">{{ type }} [{{ total_count }}]</span>{% else %}<span class="empty-state">None found.</span>{% endfor %}
                </div>
            </div>
        </div>
        
        {# Relation Cardinality Patterns #}
        <div class="summary-section collapsible collapsed">
            <div class="collapsible-header">
                <h3>Relation Cardinality Patterns</h3>
                <span class="chevron"></span>
            </div>
            <div class="collapsible-content">
                <h4>One-to-One (by Type)</h4>
                <ul class="stats-list">
                    {% for rel, patterns in one_to_one_relations_sorted %}
                    <li>
                        <code class="pattern-rel filterable-relation" data-relation-form="{{ rel }}">{{ rel }}</code>
                        <span>{{ relation_frequency_map.get(rel, 0) }} occurrence(s) • {{ patterns|length }} pattern(s){% if patterns %}, e.g., ({{ patterns[0][0] }}){% endif %}</span>
                    </li>
                    {% else %}
                    <li class="empty-state">No self-relations (e.g., PERSON &rarr; PERSON) found.</li>
                    {% endfor %}
                </ul>
                <h4>One-to-Many Relations</h4>
                <ul class="stats-list">
                    {% for rel in one_to_many_relations_sorted %}
                    <li>
                        <code class="pattern-rel filterable-relation" data-relation-form="{{ rel }}">{{ rel }}</code>
                        <span>{{ relation_frequency_map.get(rel, 0) }} occurrence(s) (1:N Cardinality)</span>
                    </li>
                    {% else %}
                    <li class="empty-state" style="justify-content: flex-start;">None found.</li>
                    {% endfor %}
                </ul>
                <h4>Many-to-One Relations</h4>
                <ul class="stats-list">
                    {% for rel in many_to_one_relations_sorted %}
                    <li>
                        <code class="pattern-rel filterable-relation" data-relation-form="{{ rel }}">{{ rel }}</code>
                        <span>{{ relation_frequency_map.get(rel, 0) }} occurrence(s) (N:1 Cardinality)</span>
                    </li>
                    {% else %}
                    <li class="empty-state" style="justify-content: flex-start;">None found.</li>
                    {% endfor %}
                </ul>
                <h4>Top {{ top_diverse_relations|length }} Relations by Domain/Range Diversity</h4>
                <ul class="stats-list">
                    {% for item in top_diverse_relations %}<li><code class="pattern-rel filterable-relation" data-relation-form="{{ item.rel }}">{{ item.rel }}</code> <span>{{ item.domain_size }} Subj Type(s) / {{ item.range_size }} Obj Type(s)</span></li>{% else %}<li class="empty-state">Not enough data to analyze diversity.</li>{% endfor %}
                </ul>
            </div>
        </div>

        {# Frequent Structural Patterns #}
        {% if most_frequent_patterns %}
        <div class="summary-section patterns-column collapsible collapsed">
            <div class="collapsible-header section-header-with-actions">
                <h3>Frequent Structural Patterns</h3>
                <span class="chevron"></span>
            </div>
            <div class="collapsible-content">
                <div class="patterns-controls" style="display: flex; gap: var(--sp-4); align-items: center; margin-bottom: var(--sp-4); flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: var(--sp-2); font-size: var(--fs-sm); color: var(--fg-secondary);">
                        Show:
                        <select id="patterns-display-count" style="padding: var(--sp-1) var(--sp-2); border-radius: var(--radius-interactive); border: 1px solid var(--border-primary); font-family: var(--font-primary); font-size: var(--fs-sm); background: var(--bg-primary);">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="150">150</option>
                        </select>
                    </label>
                    <label style="display: flex; align-items: center; gap: var(--sp-2); font-size: var(--fs-sm); color: var(--fg-secondary);">
                        Sort:
                        <button id="patterns-sort-toggle" class="network-control-btn" style="font-size: var(--fs-sm); padding: var(--sp-1) var(--sp-3);" title="Toggle sort order">
                            Descending ▼
                        </button>
                    </label>
                </div>
                <ol id="structural-patterns-list" class="patterns-list-single">
                    {% for pattern, count in most_frequent_patterns %}<li data-filter-subject="{{ pattern[0] }}" data-filter-relation="{{ pattern[1] }}" data-filter-object="{{ pattern[2] }}" data-count="{{ count }}"><span class="rank">{{ loop.index }}.</span><span class="pattern">{{ pattern[0] }} &rarr; <span class="pattern-rel">{{ pattern[1] }}</span> &rarr; {{ pattern[2] }}</span><span class="count">{{ count }}</span></li>{% endfor %}
                </ol>
            </div>
        </div>
        {% endif %}
    </div>
</aside>
