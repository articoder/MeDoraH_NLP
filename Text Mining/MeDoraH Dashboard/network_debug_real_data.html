<!DOCTYPE html>
<html>
<head>
    <title>Network Debug - Real Data</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        #network { width: 100%; height: 500px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 10px; font-family: monospace; font-size: 12px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { margin: 2% auto; width: 96%; height: 96%; background: white; border-radius: 8px; display: flex; flex-direction: column; }
        .modal-header { padding: 20px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; }
        .network-container { flex: 1; min-height: 500px; }
        #modal-network { width: 100% !important; height: 100% !important; min-height: 500px !important; }
    </style>
</head>
<body>
    <h1>Network Visualization - Real Data Test</h1>
    
    <div class="test-section">
        <h3>Step 1: Load Real JSON Data</h3>
        <button onclick="loadRealData()">Load extracted_data.json</button>
        <div id="data-status">Ready to load data...</div>
    </div>
    
    <div class="test-section">
        <h3>Step 2: Test Network in Page</h3>
        <button onclick="createInlineNetwork()">Create Network (Inline)</button>
        <div id="inline-status">Ready</div>
        <div id="network"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 3: Test Network in Modal</h3>
        <button onclick="showModalNetwork()">Create Network (Modal)</button>
        <div id="modal-status">Ready</div>
    </div>
    
    <div class="test-section">
        <h3>Debug Log</h3>
        <div id="log" class="log"></div>
    </div>

    <!-- Modal -->
    <div id="network-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Network Visualization in Modal</h2>
                <button onclick="hideModal()">Close</button>
            </div>
            <div class="network-container">
                <div id="modal-network"></div>
            </div>
        </div>
    </div>

    <script>
        let realData = null;
        
        function log(message) {
            console.log(message);
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML = `[${timestamp}] ${message}<br>` + logEl.innerHTML;
        }
        
        async function loadRealData() {
            const statusEl = document.getElementById('data-status');
            try {
                statusEl.textContent = 'Loading...';
                
                const response = await fetch('extracted_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                realData = await response.json();
                log(`‚úÖ Loaded real data: ${realData.length} speaker turns`);
                
                // Count total extractions
                let totalExtractions = 0;
                realData.forEach(turn => {
                    if (turn.extractions) {
                        totalExtractions += turn.extractions.length;
                    }
                });
                
                statusEl.innerHTML = `‚úÖ Data loaded successfully!<br>
                    ${realData.length} speaker turns<br>
                    ${totalExtractions} total extractions`;
                    
                log(`Total extractions: ${totalExtractions}`);
                
            } catch (error) {
                log(`‚ùå Error loading data: ${error.message}`);
                statusEl.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        function processTriples() {
            if (!realData) {
                log('‚ùå No data loaded');
                return [];
            }
            
            const allTriples = [];
            realData.forEach(turn => {
                if (turn.extractions && Array.isArray(turn.extractions)) {
                    turn.extractions.forEach(extraction => {
                        if (extraction.subject_entity && extraction.object_entity && extraction.relation) {
                            allTriples.push(extraction);
                        }
                    });
                }
            });
            
            log(`üîÑ Processed ${allTriples.length} valid triples`);
            return allTriples.slice(0, 50); // Take first 50 for testing
        }
        
        function createNetworkData(triples) {
            const nodesMap = new Map();
            const edges = [];
            const colorPalette = ['#E69F00', '#56B4E9', '#009E73', '#F0E442', '#0072B2', '#D55E00', '#CC79A7'];
            const entityTypes = new Set();
            
            triples.forEach(triple => {
                const subjName = triple.subject_entity.name;
                const subjType = triple.subject_entity.entity_type;
                const objName = triple.object_entity.name;
                const objType = triple.object_entity.entity_type;
                const relation = triple.relation.semantic_form;
                
                entityTypes.add(subjType);
                entityTypes.add(objType);
                
                // Add nodes
                if (!nodesMap.has(subjName)) {
                    nodesMap.set(subjName, {
                        id: subjName,
                        label: subjName,
                        type: subjType,
                        degree: 0
                    });
                }
                nodesMap.get(subjName).degree++;
                
                if (!nodesMap.has(objName)) {
                    nodesMap.set(objName, {
                        id: objName,
                        label: objName,
                        type: objType,
                        degree: 0
                    });
                }
                nodesMap.get(objName).degree++;
                
                // Add edge
                edges.push({
                    from: subjName,
                    to: objName,
                    label: relation,
                    arrows: 'to'
                });
            });
            
            // Create color mapping
            const typeArray = Array.from(entityTypes).sort();
            const colorMap = {};
            typeArray.forEach((type, index) => {
                colorMap[type] = colorPalette[index % colorPalette.length];
            });
            
            // Convert to vis.js format
            const visNodes = Array.from(nodesMap.values()).map(node => ({
                id: node.id,
                label: node.label,
                title: `Entity: ${node.label}\\nType: ${node.type}\\nConnections: ${node.degree}`,
                color: colorMap[node.type] || '#999999',
                size: Math.max(10, Math.min(30, node.degree * 3))
            }));
            
            log(`üé® Created network data: ${visNodes.length} nodes, ${edges.length} edges`);
            
            return {
                nodes: new vis.DataSet(visNodes),
                edges: new vis.DataSet(edges)
            };
        }
        
        function createInlineNetwork() {
            const statusEl = document.getElementById('inline-status');
            
            try {
                statusEl.textContent = 'Creating network...';
                log('üé® Creating inline network...');
                
                const triples = processTriples();
                if (triples.length === 0) {
                    statusEl.textContent = '‚ùå No data to visualize';
                    return;
                }
                
                const data = createNetworkData(triples);
                const container = document.getElementById('network');
                
                if (!container) {
                    throw new Error('Container not found');
                }
                
                log(`Container dimensions: ${container.offsetWidth}x${container.offsetHeight}`);
                
                const options = {
                    nodes: {
                        font: { size: 14, color: '#343434' }
                    },
                    edges: {
                        font: { size: 10, color: '#343434' }
                    },
                    physics: {
                        enabled: true,
                        stabilization: { iterations: 200 }
                    }
                };
                
                const network = new vis.Network(container, data, options);
                
                network.on('stabilizationIterationsDone', () => {
                    log('‚úÖ Network stabilized');
                    network.setOptions({ physics: false });
                });
                
                statusEl.textContent = '‚úÖ Inline network created successfully!';
                log('‚úÖ Inline network created');
                
            } catch (error) {
                log(`‚ùå Error creating inline network: ${error.message}`);
                statusEl.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        function showModalNetwork() {
            const statusEl = document.getElementById('modal-status');
            
            try {
                statusEl.textContent = 'Opening modal...';
                log('üîÑ Opening modal...');
                
                document.getElementById('network-modal').style.display = 'block';
                
                setTimeout(() => {
                    statusEl.textContent = 'Creating network in modal...';
                    log('üé® Creating modal network...');
                    
                    const triples = processTriples();
                    if (triples.length === 0) {
                        statusEl.textContent = '‚ùå No data to visualize';
                        return;
                    }
                    
                    const data = createNetworkData(triples);
                    const container = document.getElementById('modal-network');
                    
                    if (!container) {
                        throw new Error('Modal container not found');
                    }
                    
                    log(`Modal container dimensions: ${container.offsetWidth}x${container.offsetHeight}`);
                    
                    const options = {
                        nodes: {
                            font: { size: 14, color: '#343434' }
                        },
                        edges: {
                            font: { size: 10, color: '#343434' }
                        },
                        physics: {
                            enabled: true,
                            stabilization: { iterations: 200 }
                        }
                    };
                    
                    const network = new vis.Network(container, data, options);
                    
                    // Force resize
                    setTimeout(() => {
                        network.redraw();
                        network.fit();
                        log('‚úÖ Network resized and fitted');
                    }, 100);
                    
                    network.on('stabilizationIterationsDone', () => {
                        log('‚úÖ Modal network stabilized');
                        network.setOptions({ physics: false });
                    });
                    
                    statusEl.textContent = '‚úÖ Modal network created successfully!';
                    log('‚úÖ Modal network created');
                    
                }, 300);
                
            } catch (error) {
                log(`‚ùå Error creating modal network: ${error.message}`);
                statusEl.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        function hideModal() {
            document.getElementById('network-modal').style.display = 'none';
            log('Modal hidden');
        }
        
        // Auto-load data on page load
        window.addEventListener('load', () => {
            if (typeof vis !== 'undefined') {
                log('‚úÖ vis.js loaded successfully');
            } else {
                log('‚ùå vis.js failed to load');
            }
            
            // Auto-load data
            setTimeout(loadRealData, 500);
        });
    </script>
</body>
</html>